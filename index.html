<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Essex Postcode Districts – The Learning Hive</title>
<link href="https://fonts.googleapis.com/css2?family=Balloo+2:wght@600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body {
  margin:0;
  height:100%;
  font-family:'Nunito',sans-serif;
  overflow:hidden;
  background:#f7f7f7;
}
#map {
  position:absolute;
  top:0;left:0;bottom:0;right:290px;
  z-index:1;
}

/* Sidebar */
#sidebar {
  position:fixed;
  top:0;right:0;
  width:290px;height:100%;
  background:rgba(255,255,255,0.95);
  box-shadow:-4px 0 10px rgba(0,0,0,0.1);
  backdrop-filter:blur(6px);
  overflow-y:auto;
  padding:1rem;
  z-index:1000;
}
#sidebar h2{
  font-family:'Balloo 2',sans-serif;
  font-size:1.3rem;
  margin:0 0 .75rem 0;
}
#search{
  width:100%;
  padding:0.5rem 0.75rem;
  border-radius:8px;
  border:1px solid #ddd;
  margin-bottom:1rem;
}
#list{
  max-height:calc(100vh - 120px);
  overflow-y:auto;
  scroll-behavior:smooth;
}
#list::-webkit-scrollbar{width:6px;}
#list::-webkit-scrollbar-thumb{
  background:rgba(0,0,0,0.15);
  border-radius:4px;
}
.item{
  padding:0.4rem 0.5rem;
  margin-bottom:0.3rem;
  border-radius:6px;
  transition:background 0.2s ease,transform 0.15s ease;
  cursor:pointer;
}
.item:hover{
  background:rgba(0,0,0,0.05);
  transform:translateX(-2px);
}
.item.active{
  background:rgba(100,100,255,0.15);
}
.pc{font-weight:600;}
.mtown{font-size:0.9rem;color:#444;}
.locals{font-size:0.8rem;color:#777;}

/* Reset button */
#resetBtn{
  position:fixed;
  bottom:15px;
  right:310px;
  z-index:1200;
  background:#fff;
  border:1px solid #ccc;
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer;
  display:none;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}

/* Map labels */
.pc-label span{
  font-size:0.9rem;
  font-weight:600;
  text-shadow:0 0 4px rgba(255,255,255,0.8);
}

/* Footer credit & logo */
.footer{
  position:fixed;
  bottom:10px;
  left:10px;
  font-size:0.75rem;
  color:#666;
  display:flex;
  align-items:center;
  gap:6px;
  opacity:0.8;
}
.footer img{
  height:22px;
  width:auto;
  opacity:0.85;
}
</style>
</head>

<body>
<div id="map"></div>
<div id="sidebar">
  <h2>Essex Postcode Districts</h2>
  <input id="search" type="text" placeholder="Filter by postcode or place...">
  <div id="list"></div>
</div>
<button id="resetBtn">Reset View</button>

<div class="footer">
  <img src="https://raw.githubusercontent.com/sibsss/essex/main/learninghive-logo.png" alt="Learning Hive Logo">
  © The Learning Hive 2025
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map',{
  minZoom:8,
  maxZoom:14,
  maxBounds:L.latLngBounds([[51.35,-0.5],[52.2,1.5]]),
  maxBoundsViscosity:1.0,
  inertia:true,
  inertiaDeceleration:2000
}).setView([51.77,0.54],9);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'© OpenStreetMap'
}).addTo(map);

const areas={CM:'#1f77b4',CO:'#ff7f0e',SS:'#2ca02c',IG:'#d62728',RM:'#9467bd',EN:'#2ca9a4'};
const files=['CM','CO','SS','IG','RM','EN'];

const districtInfo={
  "CM16":{main:"Epping",locals:["Theydon Bois","North Weald","Waltham Abbey"]},
  "CM20":{main:"Harlow",locals:["Town Centre","Church Langley","Newhall"]},
  "CM1":{main:"Chelmsford",locals:["Writtle","Broomfield"]},
  "CM2":{main:"Chelmsford",locals:["Great Baddow","Galleywood"]},
  "CO1":{main:"Colchester"},
  "SS1":{main:"Southend-on-Sea"},
  "IG10":{main:"Loughton"},
  "RM14":{main:"Upminster"},
  "EN9":{main:"Waltham Abbey"}
};

function guessTown(code){
  const base=code.slice(0,2);
  const map={
    CM:"Chelmsford / Harlow / Braintree",
    CO:"Colchester",
    SS:"Southend-on-Sea",
    IG:"Loughton / Chigwell / Buckhurst Hill",
    RM:"Romford / Upminster",
    EN:"Waltham Abbey / Epping"
  };
  return map[base]||"Essex District";
}

const essexBounds=L.latLngBounds([[51.42,-0.1],[52.19,1.25]]);
const layerGroup=L.layerGroup().addTo(map);
const labelGroup=L.layerGroup().addTo(map);
const codeLayer=new Map();
const codeBounds=new Map();
const resetBtn=document.getElementById('resetBtn');

Promise.all(
  files.map(f=>fetch(`data/${f}.json`).then(r=>r.json()).then(j=>({f,j})))
).then(data=>{
  data.forEach(({f,j})=>{
    L.geoJSON(j,{
      style:()=>({color:areas[f],weight:1.2,fillOpacity:0.1}),
      onEachFeature:(feature,layer)=>{
        const code=feature.properties.name||feature.properties.postcode;
        if(!code)return;

        // auto town detection
        let info=districtInfo[code];
        if(!info){
          const match=Object.values(districtInfo).find(d=>
            (d.locals||[]).some(n=>code.toLowerCase().includes(n.toLowerCase().slice(0,3)))
          );
          info=match||{main:guessTown(code),locals:[]};
        }

        codeLayer.set(code,layer);
        codeBounds.set(code,layer.getBounds());
        const c=layer.getBounds().getCenter();
        const icon=L.divIcon({
          className:"pc-label",
          html:`<span style="color:${areas[f]}">${code}<br><small>${info.main}</small></span>`
        });
        const marker=L.marker(c,{icon});
        marker.addTo(labelGroup);
        marker.bindTooltip(`${code} — ${info.main}`,{direction:"top",offset:[0,-8]});
        layer.on("mouseover",()=>highlight(code));
        layer.on("mouseout",()=>!locked&&clearHighlight());
        layer.on("click",()=>toggleLock(code));
      }
    }).addTo(layerGroup);
  });
  buildSidebar();
  map.flyToBounds(essexBounds.pad(0.05),{duration:2});
  map.on("zoomend",()=>document.body.classList.toggle("labels-visible",map.getZoom()>=10));
});

let locked=null;
function highlight(code){
  clearHighlight();
  const l=codeLayer.get(code);
  if(!l)return;
  const area=code.slice(0,2);
  l.setStyle({color:areas[area],weight:3,fillOpacity:0.25});
  const item=document.querySelector(`.item[data-code="${code}"]`);
  if(item)item.classList.add('active');
}
function clearHighlight(){
  codeLayer.forEach((l,c)=>{
    const a=c.slice(0,2);
    l.setStyle({color:areas[a],weight:1.2,fillOpacity:0.1});
  });
  document.querySelectorAll('.item').forEach(i=>i.classList.remove('active'));
}
function toggleLock(code){
  if(locked===code){locked=null;resetView();}
  else{
    locked=code;highlight(code);
    if(codeBounds.has(code))map.flyToBounds(codeBounds.get(code).pad(0.08),{duration:1.8});
    resetBtn.style.display='block';
  }
}
function resetView(){
  locked=null;clearHighlight();
  map.flyToBounds(essexBounds.pad(0.05),{duration:1.8});
  resetBtn.style.display='none';
}
resetBtn.onclick=()=>resetView();

function buildSidebar(){
  const list=document.getElementById('list');
  const arr=[...codeLayer.keys()].sort();
  list.innerHTML=arr.map(c=>{
    const d=districtInfo[c]||{main:guessTown(c),locals:[]};
    const areaColor=areas[c.slice(0,2)]||'#ccc';
    return `<div class="item" data-code="${c}" style="--area:${areaColor}">
      <div class="pc">${c}</div>
      <div class="mtown">${d.main}</div>
      <div class="locals">${(d.locals||[]).join(', ')}</div>
    </div>`;
  }).join('');
  list.onclick=e=>{
    const i=e.target.closest('.item');
    if(!i)return;
    toggleLock(i.dataset.code);
  };
  const search=document.getElementById('search');
  search.oninput=()=>{
    const q=search.value.toLowerCase();
    for(const i of list.children){
      i.style.display=i.textContent.toLowerCase().includes(q)?'':'none';
    }
  };
}

/* Sidebar colour hover effect */
document.addEventListener('mouseover',e=>{
  const i=e.target.closest('.item');
  if(i)i.style.background=`color-mix(in srgb, var(--area) 20%, white)`;
});
document.addEventListener('mouseout',e=>{
  const i=e.target.closest('.item');
  if(i)i.style.background='';
});
</script>
</body>
</html>
